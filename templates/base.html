<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ brand_name }} Battery Tracker{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&family=Albert+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        :root {
            /* Brand colors — set dynamically */
            --brand-primary: {{ brand.primary }};
            --brand-bright: {{ brand.bright }};
            --brand-dim: {{ brand.dim }};
            --brand-dark: {{ brand.dark }};
            --brand-ghost: {{ brand.ghost }};
            --brand-glow: {{ brand.glow }};
            --brand-text: {{ brand.text_on_brand }};

            /* Neutral palette */
            --bg-deepest: #d0d3d9;
            --bg-primary: #d8dbe0;
            --bg-secondary: #e4e6eb;
            --bg-tertiary: #d0d3d9;
            --bg-elevated: #e4e6eb;

            --border-default: #bfc3cb;
            --border-hover: #a8adb8;

            --text-primary: #1a2332;
            --text-secondary: #3d4a5c;
            --text-muted: #5a6475;
            --text-inverse: #ffffff;

            --accent-amber: #c48508;
            --accent-amber-ghost: rgba(196, 133, 8, 0.10);
            --accent-red: #cc3d35;
            --accent-red-ghost: rgba(204, 61, 53, 0.09);
            --accent-green: #1a8a3e;
            --accent-green-ghost: rgba(26, 138, 62, 0.10);
            --accent-blue: #2c6fcc;
            --accent-blue-ghost: rgba(44, 111, 204, 0.09);
            --accent-purple: #7c3aed;
            --accent-purple-ghost: rgba(124, 58, 237, 0.09);

            --font-display: 'Chakra Petch', sans-serif;
            --font-body: 'Albert Sans', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;

            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;

            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.10);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.14);
            --shadow-glow: 0 0 20px var(--brand-glow);
        }

        /* Visually hidden utility */
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        html { font-size: 15px; scroll-behavior: smooth; -webkit-font-smoothing: antialiased; }

        body {
            font-family: var(--font-body);
            background: var(--bg-deepest);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 3px;
            z-index: 10000;
            background: var(--brand-primary);
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-deepest); }
        ::-webkit-scrollbar-thumb { background: var(--border-default); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--border-hover); }

        .container { max-width: 1140px; margin: 0 auto; padding: 0 24px; }

        /* ── Navigation ── */
        .topnav {
            position: sticky; top: 3px; z-index: 100;
            background: var(--brand-dark);
            padding: 0 24px;
        }
        .topnav .container { display: flex; align-items: center; justify-content: space-between; height: 64px; }

        .topnav-brand { display: flex; align-items: center; gap: 14px; text-decoration: none; color: #fff; min-width: 0; }
        .topnav-brand svg { flex-shrink: 0; }
        .topnav-brand span {
            font-family: var(--font-display); font-weight: 700; font-size: 1.05rem;
            letter-spacing: 0.04em; text-transform: uppercase; color: #fff;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }

        .topnav-links { display: flex; align-items: center; gap: 6px; list-style: none; flex-shrink: 0; }
        .topnav-links a {
            display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px;
            font-family: var(--font-display); font-size: 0.8rem; font-weight: 500;
            letter-spacing: 0.06em; text-transform: uppercase; text-decoration: none;
            color: rgba(255,255,255,0.7); border-radius: var(--radius-sm); transition: all 0.2s ease;
        }
        .topnav-links a:hover { color: #fff; background: rgba(255,255,255,0.1); }
        .topnav-links a.nav-active { color: #fff; background: rgba(255,255,255,0.12); }
        .topnav-links .btn-add {
            color: var(--brand-text); background: var(--brand-bright); font-weight: 600;
        }
        .topnav-links .btn-add:hover, .topnav-links .btn-add.nav-active { background: #ffffff; color: var(--brand-dark); }
        .topnav-links .btn-settings { padding: 8px 10px; }
        .topnav-links .btn-settings svg { display: block; }

        main { padding: 36px 0 80px; }

        /* ── Flash messages ── */
        .flash-toast { position: fixed; top: 80px; right: 24px; z-index: 9000; display: flex; flex-direction: column; gap: 8px; }
        .flash-msg {
            display: flex; align-items: center; gap: 10px; padding: 12px 20px;
            font-family: var(--font-body); font-size: 0.88rem; font-weight: 500;
            border-radius: var(--radius-md); border: 1px solid;
            background: var(--bg-secondary); box-shadow: var(--shadow-md);
            animation: flashIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        .flash-msg.success { border-color: rgba(26,138,62,0.25); color: var(--accent-green); }
        .flash-msg.error { border-color: rgba(204,61,53,0.25); color: var(--accent-red); }
        .flash-msg .flash-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; flex-shrink: 0; }
        .flash-close {
            background: none; border: none; color: currentColor; cursor: pointer; padding: 0 0 0 6px;
            font-size: 1.1rem; line-height: 1; opacity: 0.5; transition: opacity 0.15s ease;
        }
        .flash-close:hover { opacity: 1; }
        @keyframes flashIn { from { opacity:0; transform:translateX(30px); } to { opacity:1; transform:translateX(0); } }

        /* ── Section header ── */
        .section-header { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; }
        .section-header h1 { font-family: var(--font-display); font-size: 1.5rem; font-weight: 700; letter-spacing: 0.03em; }
        .section-header .badge {
            font-family: var(--font-mono); font-size: 0.75rem; font-weight: 500;
            padding: 3px 10px; border-radius: 20px;
            background: var(--brand-ghost); color: var(--brand-primary);
            border: 1px solid var(--brand-glow);
        }

        /* ── Stats cards ── */
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px; }
        .stat-card {
            background: var(--bg-secondary); border: 1px solid var(--border-default);
            border-radius: var(--radius-md); padding: 20px 22px;
            position: relative; overflow: hidden; box-shadow: var(--shadow-sm);
            transition: border-color 0.25s ease;
            animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) backwards;
        }
        .stat-card:nth-child(1) { animation-delay: 0.05s; }
        .stat-card:nth-child(2) { animation-delay: 0.12s; }
        .stat-card:nth-child(3) { animation-delay: 0.19s; }
        .stat-card:hover { border-color: var(--border-hover); }
        .stat-card::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; }
        .stat-card:nth-child(1)::before { background: var(--brand-primary); }
        .stat-card:nth-child(2)::before { background: var(--accent-amber); }
        .stat-card:nth-child(3)::before { background: var(--accent-blue); }
        .stat-label { font-family: var(--font-display); font-size: 0.7rem; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px; }
        .stat-value { font-family: var(--font-mono); font-size: 1.6rem; font-weight: 600; color: var(--text-primary); line-height: 1.2; }
        .stat-sub { font-family: var(--font-body); font-size: 0.78rem; color: var(--text-muted); margin-top: 4px; }

        /* Status bar mini chart */
        .status-bar { display: flex; height: 8px; border-radius: 4px; overflow: hidden; gap: 2px; margin-top: 8px; }
        .status-bar-seg { min-width: 4px; transition: flex 0.3s ease; }
        .status-bar-seg.seg-new { background: var(--accent-purple); }
        .status-bar-seg.seg-in-use { background: var(--accent-green); }
        .status-bar-seg.seg-for-repair { background: var(--accent-amber); }
        .status-bar-seg.seg-repaired { background: var(--accent-blue); }
        .status-bar-seg.seg-dead { background: var(--accent-red); }
        .status-legend { display: flex; flex-wrap: wrap; gap: 6px 12px; margin-top: 8px; }
        .status-legend-item { display: flex; align-items: center; gap: 5px; font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-secondary); }
        .status-legend-dot { width: 6px; height: 6px; border-radius: 50%; }

        @keyframes fadeInUp { from { opacity:0; transform:translateY(16px); } to { opacity:1; transform:translateY(0); } }

        /* ── Filter bar ── */
        .filter-bar { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 20px; }
        .filter-pill {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 6px 14px; font-family: var(--font-display); font-size: 0.72rem;
            font-weight: 600; letter-spacing: 0.04em; text-transform: uppercase;
            text-decoration: none; border: 1px solid var(--border-default);
            border-radius: 20px; color: var(--text-secondary); background: var(--bg-secondary);
            transition: all 0.2s ease; cursor: pointer;
        }
        .filter-pill:hover { border-color: var(--border-hover); color: var(--text-primary); }
        .filter-pill.active {
            background: var(--brand-primary); color: var(--brand-text);
            border-color: var(--brand-primary);
        }
        .filter-pill .count {
            font-family: var(--font-mono); font-size: 0.68rem;
            opacity: 0.7;
        }

        /* ── Table ── */
        .table-wrap {
            background: var(--bg-secondary); border: 1px solid var(--border-default);
            border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow-sm);
            animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.2s backwards;
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.88rem; }
        thead { background: var(--bg-tertiary); }
        thead th {
            font-family: var(--font-display); font-size: 0.68rem; font-weight: 600;
            letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-muted);
            padding: 14px 16px; text-align: left; border-bottom: 1px solid var(--border-default);
        }
        tbody tr { border-bottom: 1px solid var(--border-default); transition: background 0.15s ease; }
        tbody tr:last-child { border-bottom: none; }
        tbody tr:hover { background: rgba(0,0,0,0.04); }
        tbody td { padding: 13px 16px; vertical-align: middle; }

        .cell-model { font-family: var(--font-mono); font-weight: 600; font-size: 0.9rem; color: var(--text-primary); }
        .cell-mono { font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-secondary); }
        .cell-dim { color: var(--text-muted); font-size: 0.85rem; }

        /* ── Voltage badge ── */
        .voltage-badge {
            display: inline-flex; align-items: center; gap: 5px;
            font-family: var(--font-mono); font-size: 0.78rem; font-weight: 600;
            padding: 3px 10px; border-radius: 20px; border: 1px solid;
        }
        .voltage-badge::before { content:''; width:5px; height:5px; border-radius:50%; background:currentColor; }
        .voltage-badge { color: var(--brand-primary); background: var(--brand-ghost); border-color: var(--brand-glow); }

        /* ── Status badge ── */
        .status-badge {
            display: inline-flex; align-items: center; gap: 5px;
            font-family: var(--font-mono); font-size: 0.72rem; font-weight: 600;
            padding: 3px 10px; border-radius: 20px; border: 1px solid; white-space: nowrap;
        }
        .status-badge::before { content:''; width:5px; height:5px; border-radius:50%; background:currentColor; }
        .status-badge.status-new { color: var(--accent-purple); background: var(--accent-purple-ghost); border-color: rgba(124,58,237,0.20); }
        .status-badge.status-in-use { color: var(--accent-green); background: var(--accent-green-ghost); border-color: rgba(26,138,62,0.20); }
        .status-badge.status-for-repair { color: var(--accent-amber); background: var(--accent-amber-ghost); border-color: rgba(196,133,8,0.20); }
        .status-badge.status-repaired { color: var(--accent-blue); background: var(--accent-blue-ghost); border-color: rgba(44,111,204,0.20); }
        .status-badge.status-dead { color: var(--accent-red); background: var(--accent-red-ghost); border-color: rgba(204,61,53,0.20); }

        /* ── Type badge ── */
        .type-badge {
            display: inline-flex; align-items: center;
            font-family: var(--font-mono); font-size: 0.72rem; font-weight: 600;
            padding: 3px 10px; border-radius: 4px; border: 1px solid;
        }
        .type-oem { color: var(--brand-dim); background: var(--brand-ghost); border-color: var(--brand-glow); }
        .type-aftermarket { color: var(--text-secondary); background: rgba(138,155,176,0.08); border-color: rgba(138,155,176,0.2); }

        /* ── Action buttons ── */
        .cell-actions { white-space: nowrap; display: flex; align-items: center; gap: 6px; }
        .cell-actions form { display: inline; margin: 0; }
        .btn-sm {
            display: inline-flex; align-items: center; gap: 4px; padding: 5px 12px;
            font-family: var(--font-display); font-size: 0.7rem; font-weight: 600;
            letter-spacing: 0.05em; text-transform: uppercase; text-decoration: none;
            border: 1px solid; border-radius: var(--radius-sm); cursor: pointer;
            transition: all 0.2s ease; background: transparent; line-height: 1.4;
        }
        .btn-edit { color: var(--text-secondary); border-color: var(--border-default); }
        .btn-edit:hover { color: var(--text-primary); border-color: var(--border-hover); background: var(--bg-tertiary); }
        .btn-delete { color: var(--accent-red); border-color: var(--border-default); }
        .btn-delete:hover { color: #fff; border-color: var(--accent-red); background: var(--accent-red); }

        /* ── Table footer ── */
        .table-footer {
            display: flex; align-items: center; justify-content: space-between;
            padding: 14px 16px; background: var(--bg-tertiary);
            border-top: 1px solid var(--border-default);
            font-size: 0.78rem; color: var(--text-muted);
        }
        .table-footer strong { font-family: var(--font-mono); color: var(--text-secondary); }

        /* ── Empty state ── */
        .empty-state { text-align: center; padding: 80px 24px; animation: fadeInUp 0.5s cubic-bezier(0.16,1,0.3,1) 0.1s backwards; }
        .empty-state svg { width: 80px; height: 80px; margin-bottom: 24px; }
        .empty-state h2 { font-family: var(--font-display); font-size: 1.2rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; }
        .empty-state p { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 28px; }

        /* ── Buttons ── */
        .btn-primary {
            display: inline-flex; align-items: center; gap: 6px; padding: 10px 22px;
            font-family: var(--font-display); font-size: 0.82rem; font-weight: 600;
            letter-spacing: 0.05em; text-transform: uppercase; text-decoration: none;
            color: var(--brand-text); background: var(--brand-primary);
            border: none; border-radius: var(--radius-sm); cursor: pointer; transition: all 0.2s ease;
        }
        .btn-primary:hover { background: var(--brand-bright); box-shadow: var(--shadow-glow); }

        .btn-secondary {
            display: inline-flex; align-items: center; gap: 6px; padding: 10px 22px;
            font-family: var(--font-display); font-size: 0.82rem; font-weight: 600;
            letter-spacing: 0.05em; text-transform: uppercase; text-decoration: none;
            color: var(--text-secondary); background: transparent;
            border: 1px solid var(--border-default); border-radius: var(--radius-sm);
            cursor: pointer; transition: all 0.2s ease;
        }
        .btn-secondary:hover { color: var(--text-primary); border-color: var(--border-hover); background: var(--bg-tertiary); }

        /* ── Form ── */
        .form-card {
            background: var(--bg-secondary); border: 1px solid var(--border-default);
            border-radius: var(--radius-lg); padding: 36px; max-width: 640px; margin: 0 auto;
            box-shadow: var(--shadow-sm);
            animation: fadeInUp 0.5s cubic-bezier(0.16,1,0.3,1) 0.1s backwards;
        }
        .form-card h1 {
            font-family: var(--font-display); font-size: 1.4rem; font-weight: 700;
            letter-spacing: 0.03em; margin-bottom: 32px; padding-bottom: 20px;
            border-bottom: 1px solid var(--border-default);
        }
        .form-group { margin-bottom: 22px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .form-label {
            display: block; font-family: var(--font-display); font-size: 0.7rem;
            font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase;
            color: var(--text-muted); margin-bottom: 8px;
        }
        .form-label .required { color: var(--accent-red); margin-left: 2px; }
        .form-input {
            display: block; width: 100%; padding: 11px 14px;
            font-family: var(--font-body); font-size: 0.92rem;
            color: var(--text-primary); background: var(--bg-primary);
            border: 1px solid var(--border-default); border-radius: var(--radius-sm);
            outline: none; transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .form-input::placeholder { color: var(--text-muted); }
        .form-input:focus { border-color: var(--brand-primary); box-shadow: 0 0 0 3px var(--brand-glow); }
        textarea.form-input { resize: vertical; min-height: 80px; }
        select.form-input {
            appearance: none; cursor: pointer; padding-right: 36px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M2 4l4 4 4-4' stroke='%234a5568' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 12px center;
        }
        select.form-input option { background: var(--bg-elevated); color: var(--text-primary); }
        .form-hint { font-size: 0.75rem; color: var(--text-muted); margin-top: 6px; }
        .form-actions { display: flex; gap: 12px; margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border-default); }

        /* ── Settings ── */
        .settings-card { max-width: 500px; }
        .settings-warning {
            display: flex; align-items: flex-start; gap: 10px; padding: 12px 16px;
            background: var(--accent-amber-ghost); border: 1px solid rgba(196,133,8,0.20);
            border-radius: var(--radius-sm); margin-bottom: 20px;
            font-size: 0.82rem; color: var(--text-secondary); line-height: 1.5;
        }
        .settings-warning svg { flex-shrink: 0; margin-top: 2px; }
        .brand-option {
            display: flex; align-items: center; gap: 12px; padding: 12px 16px;
            border: 2px solid var(--border-default); border-radius: var(--radius-md);
            cursor: pointer; transition: all 0.15s ease; margin-bottom: 8px;
        }
        .brand-option:hover { border-color: var(--border-hover); background: var(--bg-primary); }
        .brand-option.selected { border-color: var(--brand-primary); background: var(--brand-ghost); }
        .brand-option input[type="radio"] {
            opacity: 0; position: absolute; width: 1px; height: 1px;
        }
        .brand-option:has(input:focus-visible) {
            outline: 2px solid var(--brand-primary); outline-offset: 2px;
        }
        .brand-swatch { width: 32px; height: 32px; border-radius: var(--radius-sm); flex-shrink: 0; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.12); }
        .brand-option-name { font-family: var(--font-display); font-weight: 600; font-size: 0.95rem; }
        .brand-option-voltages { font-family: var(--font-mono); font-size: 0.75rem; color: var(--text-muted); }

        /* ── Delete modal ── */
        .modal-backdrop {
            position: fixed; inset: 0; z-index: 8000;
            background: rgba(26,35,50,0.40); backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center;
            visibility: hidden; opacity: 0; pointer-events: none;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }
        .modal-backdrop.active { visibility: visible; opacity: 1; pointer-events: auto; }
        .modal-box {
            background: var(--bg-secondary); border: 1px solid var(--border-default);
            border-radius: var(--radius-lg); padding: 32px; max-width: 400px; width: 90%;
            box-shadow: var(--shadow-lg); animation: fadeInUp 0.25s cubic-bezier(0.16,1,0.3,1);
        }
        .modal-box h3 { font-family: var(--font-display); font-size: 1.1rem; font-weight: 600; margin-bottom: 10px; }
        .modal-box p { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 24px; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .btn-danger {
            display: inline-flex; align-items: center; gap: 6px; padding: 9px 20px;
            font-family: var(--font-display); font-size: 0.8rem; font-weight: 600;
            letter-spacing: 0.04em; text-transform: uppercase; color: #fff;
            background: var(--accent-red); border: none; border-radius: var(--radius-sm);
            cursor: pointer; transition: all 0.2s ease;
        }
        .btn-danger:hover { background: #b0332b; }

        /* ── Flatpickr override ── */
        .flatpickr-calendar { background: var(--bg-elevated); border: 1px solid var(--border-default); border-radius: var(--radius-md); box-shadow: var(--shadow-md); font-family: var(--font-body); }
        .flatpickr-calendar.arrowTop::before, .flatpickr-calendar.arrowTop::after { display: none; }
        .flatpickr-months { background: var(--bg-elevated); border-radius: var(--radius-md) var(--radius-md) 0 0; padding: 6px 0; }
        .flatpickr-months .flatpickr-month { color: var(--text-primary); fill: var(--text-primary); }
        .flatpickr-current-month { font-family: var(--font-display); font-weight: 600; font-size: 0.95rem; color: var(--text-primary); }
        .flatpickr-current-month .flatpickr-monthDropdown-months { background: var(--bg-elevated); color: var(--text-primary); font-family: var(--font-display); font-weight: 600; appearance: none; }
        .flatpickr-current-month input.cur-year { color: var(--text-primary); font-family: var(--font-display); font-weight: 600; }
        .flatpickr-months .flatpickr-prev-month, .flatpickr-months .flatpickr-next-month { fill: var(--text-secondary); color: var(--text-secondary); }
        .flatpickr-months .flatpickr-prev-month:hover, .flatpickr-months .flatpickr-next-month:hover { fill: var(--brand-primary); color: var(--brand-primary); }
        .flatpickr-months .flatpickr-prev-month svg, .flatpickr-months .flatpickr-next-month svg { fill: inherit; }
        span.flatpickr-weekday { color: var(--text-muted); font-family: var(--font-display); font-size: 0.68rem; font-weight: 600; letter-spacing: 0.05em; text-transform: uppercase; }
        .flatpickr-day { color: var(--text-primary); border-radius: var(--radius-sm); font-size: 0.85rem; border: none; }
        .flatpickr-day:hover { background: var(--bg-tertiary); border-color: transparent; color: var(--text-primary); }
        .flatpickr-day.today { border: 1px solid var(--brand-dim); color: var(--brand-primary); }
        .flatpickr-day.today:hover { background: var(--brand-ghost); color: var(--brand-primary); }
        .flatpickr-day.selected { background: var(--brand-primary) !important; color: var(--brand-text) !important; border-color: transparent; }
        .flatpickr-day.selected:hover { background: var(--brand-bright) !important; }
        .flatpickr-day.flatpickr-disabled, .flatpickr-day.prevMonthDay, .flatpickr-day.nextMonthDay { color: var(--text-muted); opacity: 0.4; }
        .flatpickr-innerContainer { border-bottom: none; }
        .dayContainer { padding: 4px 8px 8px; }

        /* ── Reduced motion ── */
        @media (prefers-reduced-motion: reduce) {
            .stat-card, .table-wrap, .form-card, .empty-state, .flash-msg, .modal-box {
                animation: none !important;
            }
            *, *::before, *::after {
                transition-duration: 0.01ms !important;
                animation-duration: 0.01ms !important;
            }
        }

        /* ── Responsive ── */
        @media (max-width: 768px) {
            .container { padding: 0 16px; }
            main { padding: 24px 0 60px; }
            .topnav-brand span { font-size: 0.85rem; }
            .stats-row { grid-template-columns: 1fr 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .form-card { padding: 24px; }
            table, thead, tbody, th, td, tr { display: block; }
            thead { display: none; }
            tbody tr { padding: 16px; margin-bottom: 2px; }
            tbody td { padding: 3px 0; display: flex; align-items: center; gap: 8px; }
            tbody td::before {
                content: attr(data-label);
                font-family: var(--font-display); font-size: 0.65rem; font-weight: 600;
                letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-muted); flex: 0 0 85px;
            }
            tbody td.cell-actions::before { display: none; }
            .cell-actions { padding-top: 10px !important; margin-top: 6px; border-top: 1px solid var(--border-default); }
            .btn-sm { padding: 9px 14px; }
        }
        @media (max-width: 480px) {
            .stats-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <nav class="topnav" aria-label="Main navigation">
        <div class="container">
            <a href="{{ url_for('index') }}" class="topnav-brand">
                <svg width="36" height="36" viewBox="0 0 38 38" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <rect x="4" y="10" width="30" height="26" rx="4" fill="{{ brand.primary }}"/>
                    <rect x="11" y="3" width="16" height="9" rx="2.5" fill="rgba(255,255,255,0.2)"/>
                    <rect x="14" y="5" width="4" height="4" rx="1" fill="rgba(255,255,255,0.3)"/>
                    <rect x="20" y="5" width="4" height="4" rx="1" fill="rgba(255,255,255,0.3)"/>
                    <rect x="5.5" y="14" width="2" height="18" rx="1" fill="rgba(0,0,0,0.12)"/>
                    <rect x="30.5" y="14" width="2" height="18" rx="1" fill="rgba(0,0,0,0.12)"/>
                    <path d="M21.5 17 L17 24.5 L20 24.5 L16.5 32 L23 23.5 L20 23.5 Z" fill="#fff" opacity="0.95"/>
                    <circle cx="12" cy="33" r="1.2" fill="rgba(255,255,255,0.5)"/>
                    <circle cx="16" cy="33" r="1.2" fill="rgba(255,255,255,0.5)"/>
                    <circle cx="20" cy="33" r="1.2" fill="rgba(255,255,255,0.5)"/>
                    <circle cx="24" cy="33" r="1.2" fill="rgba(255,255,255,0.3)"/>
                </svg>
                <span>{{ brand_name }} Battery Tracker</span>
            </a>
            <ul class="topnav-links">
                <li><a href="{{ url_for('index') }}" {{ 'class=nav-active' if request.endpoint == 'index' else '' }}>Inventory</a></li>
                <li><a href="{{ url_for('add') }}" class="btn-add {{ 'nav-active' if request.endpoint == 'add' else '' }}">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="none" aria-hidden="true"><line x1="8" y1="3" x2="8" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="3" y1="8" x2="13" y2="8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                    Add Battery</a></li>
                <li><a href="{{ url_for('feedback') }}" class="{{ 'nav-active' if request.endpoint == 'feedback' else '' }}" aria-label="Feedback">
                    <svg width="16" height="16" viewBox="0 0 20 20" fill="none" aria-hidden="true"><path d="M18 10c0 4-3.6 7-8 7a8.7 8.7 0 01-3.2-.6L3 18l1.3-3.1C2.8 13.4 2 11.8 2 10c0-4 3.6-7 8-7s8 3 8 7z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </a></li>
                <li><a href="{{ url_for('settings') }}" class="btn-settings {{ 'nav-active' if request.endpoint == 'settings' else '' }}" aria-label="Settings">
                    <svg width="18" height="18" viewBox="0 0 20 20" fill="none" aria-hidden="true"><path d="M10 12.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z" stroke="currentColor" stroke-width="1.5"/><path d="M16.2 12.2a1.4 1.4 0 00.28 1.54l.05.05a1.7 1.7 0 11-2.4 2.4l-.05-.05a1.4 1.4 0 00-1.54-.28 1.4 1.4 0 00-.85 1.28v.15a1.7 1.7 0 11-3.4 0v-.08a1.4 1.4 0 00-.92-1.28 1.4 1.4 0 00-1.54.28l-.05.05a1.7 1.7 0 11-2.4-2.4l.05-.05a1.4 1.4 0 00.28-1.54 1.4 1.4 0 00-1.28-.85H2.4a1.7 1.7 0 110-3.4h.08a1.4 1.4 0 001.28-.92 1.4 1.4 0 00-.28-1.54l-.05-.05a1.7 1.7 0 112.4-2.4l.05.05a1.4 1.4 0 001.54.28h.07a1.4 1.4 0 00.85-1.28V2.4a1.7 1.7 0 013.4 0v.08a1.4 1.4 0 00.85 1.28 1.4 1.4 0 001.54-.28l.05-.05a1.7 1.7 0 112.4 2.4l-.05.05a1.4 1.4 0 00-.28 1.54v.07a1.4 1.4 0 001.28.85h.15a1.7 1.7 0 010 3.4h-.08a1.4 1.4 0 00-1.28.85z" stroke="currentColor" stroke-width="1.5"/></svg>
                </a></li>
            </ul>
        </div>
    </nav>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-toast" role="status" aria-live="polite">
            {% for category, message in messages %}
            <div class="flash-msg {{ category }}">
                <span class="flash-dot"></span>
                {{ message }}
                <button class="flash-close" onclick="this.parentElement.remove()" aria-label="Dismiss">&times;</button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    {% endwith %}

    <main><div class="container">{% block content %}{% endblock %}</div></main>

    <div class="modal-backdrop" id="deleteModal" role="dialog" aria-modal="true" aria-labelledby="deleteModalTitle" aria-describedby="deleteModalDesc">
        <div class="modal-box">
            <h3 id="deleteModalTitle">Delete Battery</h3>
            <p id="deleteModalDesc">Remove <strong id="deleteModelName"></strong> from your inventory? This can't be undone.</p>
            <div class="modal-actions">
                <button class="btn-secondary" id="deleteCancelBtn" onclick="closeDeleteModal()">Cancel</button>
                <form id="deleteForm" method="post"><button type="submit" class="btn-danger">Delete</button></form>
            </div>
        </div>
    </div>

    <noscript>
        <style>.btn-delete { display: none !important; }</style>
    </noscript>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        document.querySelectorAll('input[type="date"]').forEach(function(el) {
            var hasValue = !!el.value;
            el.type = 'text';
            el.readOnly = true;
            flatpickr(el, {
                dateFormat: 'd/m/Y',
                altInput: true,
                altFormat: 'd/m/Y',
                allowInput: false,
                animate: true,
                defaultDate: hasValue ? el.value : undefined,
                onOpen: function(selectedDates, dateStr, instance) {
                    if (!dateStr) instance.jumpToDate(new Date());
                },
            });
        });

        var deleteTriggerEl = null;
        function confirmDelete(url, name) {
            deleteTriggerEl = document.activeElement;
            document.getElementById('deleteModelName').textContent = name;
            document.getElementById('deleteForm').action = url;
            document.getElementById('deleteModal').classList.add('active');
            document.getElementById('deleteCancelBtn').focus();
        }
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            if (deleteTriggerEl) { deleteTriggerEl.focus(); deleteTriggerEl = null; }
        }
        document.getElementById('deleteModal').addEventListener('click', function(e) { if (e.target === this) closeDeleteModal(); });
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeDeleteModal();
            if (e.key === 'Tab' && document.getElementById('deleteModal').classList.contains('active')) {
                var modal = document.querySelector('.modal-box');
                var focusable = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                var first = focusable[0], last = focusable[focusable.length - 1];
                if (e.shiftKey) { if (document.activeElement === first) { e.preventDefault(); last.focus(); } }
                else { if (document.activeElement === last) { e.preventDefault(); first.focus(); } }
            }
        });

        setTimeout(function() {
            document.querySelectorAll('.flash-msg').forEach(function(el) {
                el.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
                void el.offsetHeight;
                el.style.opacity = '0';
                el.style.transform = 'translateX(30px)';
                setTimeout(function() { el.remove(); }, 400);
            });
        }, 5000);
    </script>

</body>
</html>
